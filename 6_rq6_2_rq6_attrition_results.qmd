---
title: "RQ6: compare later attrition"
format: 
  html:
    embed-resources: true
    fig-width: 8
    fig-height: 8
    code-link: true
    code-fold: true
    code-tools: true
    df-print: paged
    toc: true
    grid:
      body-width: 900px
editor: source
---

## Description

In this (non-preregistered) analysis, we look at four variables collected at years 12 & 16, and test the effect of selecting only those who took part at year 21 and 26 time points. Suggested by Yasmin.

## Load Data

```{r}
#| output: false

source("0_load_data.R")

df = df %>%
  filter(!(randomfamid %in% exclude_fams_onesib)) %>%
  filter(!(randomfamid %in% exclude_fams_rq6y)) 

## range of participation outcomes to use for attiritioning 

range_participation_outcomes = 12:14

variable_comparisons = readRDS(file.path("results","6_variable_comparisons.Rds"))

```


### Focal Variables and timepoints 

Attrition time points

```{r}

cbind(
  rq6y,
  rq6y_labels
) %>%
  knitr::kable(caption = "Outcome Variables")

cbind(
  rq1y_twin1[range_participation_outcomes],
  rq1y_twin_labels_clean[range_participation_outcomes]
) %>%
  knitr::kable(caption = "Attrittion time points")

```


## Data Processing

### Transform Raw Results to Dataframe

```{r}
# Load raw bootstrap results (already loaded above as variable_comparisons)
# variable_comparisons = readRDS(file.path("results", "6_variable_comparisons.Rds"))

# Extract bootstrap_summary from each element
variable_comparisons_df = lapply(variable_comparisons, function(x) x$bootstrap_summary)

# Transform each dataset's results
for(i in seq_along(variable_comparisons_df)){
  for (j in 1:3){ # Keep only md, smd, var, cor_resid (h removed from RQ6)
    variable_comparisons_df[[i]] = variable_comparisons_df[[i]][1:3]
    variable_comparisons_df[[i]][[j]] = do.call(rbind, variable_comparisons_df[[i]][[j]])
    variable_comparisons_df[[i]][[j]]$dataset  = rq1y_twin_labels_clean_extrashort[range_participation_outcomes[i]]
    variable_comparisons_df[[i]][[j]]$stat = c("md","smd","var")[j]
    variable_comparisons_df[[i]][[j]]$variable = rq6y_labels
    rownames(variable_comparisons_df[[i]][[j]]) = NULL
  }
  variable_comparisons_df[[i]] = do.call(rbind.data.frame, variable_comparisons_df[[i]])
}

# Combine all datasets into single dataframe
variable_comparisons_df0 = do.call(rbind.data.frame, variable_comparisons_df)
rownames(variable_comparisons_df0) = NULL

# Save for future use
# saveRDS(variable_comparisons_df0, file.path("results", "6_variable_comparisons_df.Rds"))

```

### Create Table

```{r}
# Get original variances for rescaling
original_variances = sapply(rq6y, function(x) stats::var(df[[x]], na.rm = TRUE))

# variable_comparisons_df0 created above in "Transform Raw Results to Dataframe" section
# Optionally can load from disk:
# variable_comparisons_df0 = readRDS(file.path("results", "6_variable_comparisons_df.Rds"))

# Process the dataframe
variable_comparisons_df = variable_comparisons_df0 %>%
  mutate(
    # dataset = rq1y_twin_labels_clean[match(.$dataset, rq1y_twin1)],
    variable = rq6y_labels[match(.$variable, rq6y_labels)]
  ) %>%
  # Rescale variance values
  pivot_longer(cols = starts_with("y")) %>%
  mutate(
    var_constant = original_variances[match(.$variable, rq6y_labels)],
    value = case_when(
      stat == "var" ~ value / var_constant,
      TRUE ~ value
    )
  ) %>%
  select(-var_constant) %>%
  pivot_wider(
    values_from = value,
    names_from  = name
  ) %>%
  group_by(dataset, stat) %>%
  mutate(
    pval_adj = stats::p.adjust(pval, method = "holm")
  )

```

## Means, SMDs, Variances

### GT Results Table

```{r}

variable_comparisons_df %>%
  filter(stat %in% c("md", "smd", "var")) %>%
  select(-starts_with("."),-pd, -pval) %>%
  pivot_wider(
    names_from = "stat",
    values_from = c("y","ymin","ymax","pval_adj"),
    id_cols = c("variable", "dataset")
  ) %>%
  dplyr::rename(Outcome = "variable") %>%
  gt(groupname_col = "dataset") %>%
  tab_options(
    table.width = px(800)
  ) %>%

  # Create column spanners (nested headers)
  tab_spanner(
    label = "Mean Difference",
    columns = c(y_md, ymin_md, ymax_md, pval_adj_md)
  ) %>%
  tab_spanner(
    label = "Standardized Mean Difference",
    columns = c(y_smd, ymin_smd, ymax_smd, pval_adj_smd)
  ) %>%
  tab_spanner(
    label = "Variance % Change",
    columns = c(y_var, ymin_var, ymax_var, pval_adj_var)
  ) %>%

  # Rename columns under each spanner
  cols_label(
    y_md = "Est", ymin_md = "LB", ymax_md = "UB", pval_adj_md = "p",
    y_smd = "Est", ymin_smd = "LB", ymax_smd = "UB", pval_adj_smd = "p",
    y_var = "Est", ymin_var = "LB", ymax_var = "UB", pval_adj_var = "p"
  ) %>%

  # Format numbers
  fmt(
    columns = !contains("var") & !contains("Outcome"),
    fns = function(x) {gbtoolbox::apa_num(x, n_decimal_places = 3)}
  ) %>%
  fmt(
    columns = "pval_adj_var",
    fns = function(x) {gbtoolbox::apa_num(x, n_decimal_places = 3)}
  ) %>%
  fmt_percent(
    columns = c("y_var", "ymin_var","ymax_var"),
    decimals = 2,
    drop_trailing_zeros = FALSE,
    drop_trailing_dec_mark = FALSE
  ) %>%
  # Styling - uniform font size
  tab_style(
    style = cell_text(size = px(10)),
    locations = cells_column_spanners()
  ) %>%
  tab_style(
    style = cell_text(size = px(10)),
    locations = cells_body()
  ) %>%
  tab_style(
    style = cell_text(size = px(10), align = "center"),
    locations = cells_row_groups()
  ) %>%
  tab_style(
    style = cell_text(size = px(10)),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_text(size = px(10)),
    locations = cells_footnotes()
  ) %>%

  # Highlight significant results - positive effects (light green)
  tab_style(
    style = cell_fill(color = "#d5e8d4"),
    locations = cells_body(
      columns = c(y_md, ymin_md, ymax_md, pval_adj_md),
      rows = pval_adj_md < 0.05 & y_md > 0
    )
  ) %>%
  tab_style(
    style = cell_fill(color = "#d5e8d4"),
    locations = cells_body(
      columns = c(y_smd, ymin_smd, ymax_smd, pval_adj_smd),
      rows = pval_adj_smd < 0.05 & y_smd > 0
    )
  ) %>%
  tab_style(
    style = cell_fill(color = "#d5e8d4"),
    locations = cells_body(
      columns = c(y_var, ymin_var, ymax_var, pval_adj_var),
      rows = pval_adj_var < 0.05 & y_var > 0
    )
  ) %>%

  # Highlight significant results - negative effects (light red)
  tab_style(
    style = cell_fill(color = "#f8cecc"),
    locations = cells_body(
      columns = c(y_md, ymin_md, ymax_md, pval_adj_md),
      rows = pval_adj_md < 0.05 & y_md < 0
    )
  ) %>%
  tab_style(
    style = cell_fill(color = "#f8cecc"),
    locations = cells_body(
      columns = c(y_smd, ymin_smd, ymax_smd, pval_adj_smd),
      rows = pval_adj_smd < 0.05 & y_smd < 0
    )
  ) %>%
  tab_style(
    style = cell_fill(color = "#f8cecc"),
    locations = cells_body(
      columns = c(y_var, ymin_var, ymax_var, pval_adj_var),
      rows = pval_adj_var < 0.05 & y_var < 0
    )
  ) %>%

  # Add footnotes
  tab_footnote(
    footnote = md("<em>Note.</em> Est = Estimate, LB = Lower Bound 95% Confidence Interval, UB = Upper Bound 95% Confidence Interval. Significant (p<sub>Bonferroni-Holm</sub>) effects are highlighted in green (increases) or red (decreases)."),
    placement = "right"
  ) %>%
  tab_footnote(
    footnote = "P values are Bonferroni-Holm adjusted within each participation group",
    locations = cells_column_labels(columns = contains("pval_adj")),
    placement = "right"
  ) %>%
  tab_footnote(
    footnote = md("Standardized mean difference = (Mean<sub>original</sub> - Mean<sub>attritioned</sub>) / SD<sub>original</sub>"),
    locations = cells_column_spanners(spanners = "Standardized Mean Difference"),
    placement = "right"
  ) %>%
  tab_footnote(
    footnote = md("Percentage change = (Var<sub>attritioned</sub> - Var<sub>original</sub>) / Var<sub>original</sub>"),
    locations = cells_column_spanners(spanners = "Variance % Change"),
    placement = "right"
  ) %>%
  opt_footnote_marks(marks = c("*", "â€ ","â€¡"))

```

### Create Circular Heatmaps

#### Standardised Mean Differences

```{r}
# Create circular heatmap for SMD
heatmap_data_smd = variable_comparisons_df %>%
  filter(stat == "smd") %>%
  mutate(
    outcome_labeled = rq1y_twin_labels_clean_extrashort[match(dataset, rq1y_twin_labels_clean_extrashort)],
    outcome_labeled = factor(outcome_labeled, levels = rq1y_twin_labels_clean_extrashort[range_participation_outcomes]),
    Variables_wrapped = str_wrap(variable, width = 8),
    # Set fill value to NA if not significant, otherwise keep original sign
    fill_value = case_when(
      pval_adj < 0.05 ~ y,
      TRUE ~ NA
    )
  ) %>%
  # Order variables by number of significant effects
  group_by(variable) %>%
  mutate(n_significant = sum(pval_adj < 0.05)) %>%
  ungroup() %>%
  mutate(
    Variables_wrapped = factor(Variables_wrapped,
                              levels = unique(Variables_wrapped[order(-n_significant)]))
  )

ggplot(heatmap_data_smd, aes(x = Variables_wrapped, y = outcome_labeled)) +
  geom_tile(aes(fill = fill_value),
            color = "black",
            size = 0.5) +
  geom_text(
    aes(label = ifelse(pval_adj < 0.05,
                       gsub("^(-?)0\\.", "\\1.", sprintf("%.3f", y)), ""),
        size = 3.5
    ),
    color = "black"
  ) +
  scale_size_identity() +
  coord_polar(theta = "x", start = 0, direction = 1, clip = "off") +
  scale_fill_gradient2(
    low = "#2166ac",
    mid = "white",
    high = "#d73027",
    midpoint = 0,
    na.value = "white",
    guide = "none"
  ) +
  labs(
    title = "Standardised Mean Difference",
    subtitle = expression(frac(bar(X)[attritioned] - bar(X)[original], SD[original])),
    tag = "A"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 0, size = 11),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    plot.background = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 16),
    plot.subtitle = element_text(hjust = 0.5, size = 13.5, margin = margin(b = -20)),
    plot.tag = element_text(hjust = 0, vjust = 0, size = 30, face = "bold"),
    plot.tag.position = "topleft",
    plot.margin = margin(2, 10, -33, 10)
  ) +
  {
    y_positions = seq_along(levels(heatmap_data_smd$outcome_labeled))
    labels = levels(heatmap_data_smd$outcome_labeled)

    lapply(seq_along(labels), function(i) {
      annotate("text", x = 0.5, y = y_positions[i],
               label = paste0(labels[i], " "),
               size = 3.7,
               hjust = 1, angle = 7)
    })
  }

save_plot("6_rq6_circular_heatmap_smd", width = 8, height = 8)

```

[ðŸ“Š View Full Resolution SMD Heatmap (PNG)](plots/pngs/6_rq6_circular_heatmap_smd.png)

#### Variance Differences

```{r}
# Create circular heatmap for variance differences
heatmap_data_var = variable_comparisons_df %>%
  filter(stat == "var") %>%
  mutate(
    outcome_labeled = rq1y_twin_labels_clean_extrashort[match(dataset, rq1y_twin_labels_clean_extrashort)],
    outcome_labeled = factor(outcome_labeled, levels = rq1y_twin_labels_clean_extrashort[range_participation_outcomes]),
    Variables_wrapped = str_wrap(variable, width = 8),
    # Set fill value to NA if not significant, otherwise keep original sign
    fill_value = case_when(
      pval_adj < 0.05 ~ y,
      TRUE ~ NA
    )
  ) %>%
  # Order variables by number of significant effects
  group_by(variable) %>%
  mutate(n_significant = sum(pval_adj < 0.05)) %>%
  ungroup() %>%
  mutate(
    Variables_wrapped = factor(Variables_wrapped,
                              levels = unique(Variables_wrapped[order(-n_significant)]))
  )

ggplot(heatmap_data_var, aes(x = Variables_wrapped, y = outcome_labeled)) +
  geom_tile(aes(fill = fill_value),
            color = "black",
            size = 0.5) +
  geom_text(
    aes(label = ifelse(pval_adj < 0.05,
                       paste0(sprintf("%.1f", y * 100), "%"), ""),
        size = 3.5
    ),
    color = "black"
  ) +
  scale_size_identity() +
  coord_polar(theta = "x", start = 0, direction = 1, clip = "off") +
  scale_fill_gradient2(
    low = "#2166ac",
    mid = "white",
    high = "#d73027",
    midpoint = 0,
    limits = c(-max(abs(heatmap_data_var$fill_value), na.rm = TRUE),
               max(abs(heatmap_data_var$fill_value), na.rm = TRUE)),
    na.value = "white",
    guide = "none"
  ) +
  labs(
    title = "Variance Percentage Change",
    subtitle = expression(frac(Var[attritioned] - Var[original], Var[original]) %*% 100),
    tag = "B"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 0, size = 11),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    plot.background = element_blank(),
    plot.title = element_text(hjust = 0.5, size = 16),
    plot.subtitle = element_text(hjust = 0.5, size = 13.5, margin = margin(b = -20)),
    plot.tag = element_text(hjust = 0, vjust = 0, size = 30, face = "bold"),
    plot.tag.position = "topleft",
    plot.margin = margin(2, 10, -33, 10)
  ) +
  {
    y_positions = seq_along(levels(heatmap_data_var$outcome_labeled))
    labels = levels(heatmap_data_var$outcome_labeled)

    lapply(seq_along(labels), function(i) {
      annotate("text", x = 0.5, y = y_positions[i],
               label = paste0(labels[i], " "), size = 3.7, hjust = 1, angle = 7)
    })
  }

save_plot("6_rq6_circular_heatmap_var", width = 8, height = 8)

```

[ðŸ“Š View Full Resolution Variance Heatmap (PNG)](plots/pngs/6_rq6_circular_heatmap_var.png)

## Correlations

First, some code to establish how to convert variable labels from matrix to dataframe formats.

```{r}
test_correlation_matrix = matrix(
  nrow = length(rq6y),
  ncol = length(rq6y)
  )

for(i in seq_along(rq6y)){
  for(j in seq_along(rq6y)){
    test_correlation_matrix[i,j] = paste(rq6y[i], rq6y[j], collapse = " ")
  }
}

x = test_correlation_matrix[lower.tri(test_correlation_matrix)]

x_var = str_extract(x, "^\\S+")
y_var = str_extract(x, "\\S+$")

rm(test_correlation_matrix,x)
```

### Plot

```{r}

correlation_comparisons = lapply(variable_comparisons, function(x) x$bootstrap_summary$cor_resid)

correlation_comparisons = lapply(correlation_comparisons, function(x) do.call(rbind.data.frame, x))

correlation_comparisons = lapply(correlation_comparisons, function(x) {
  x %>%
    mutate(
      pval_adj = stats::p.adjust(pval, method = "holm"),
      x_var = x_var,
      y_var = y_var
    )
})

library(patchwork)

plots = lapply(1:length(correlation_comparisons), function(i) {
  plot_lower_triangular_matrix2(
    data = correlation_comparisons[[i]],
    variables = rq6y,
    labels = rq6y_labels,
    x_var_col = "x_var",
    y_var_col = "y_var",
    value_col = "y",
    p_col = "pval_adj",
    p_threshold = 0.05,
    show_values = TRUE,
    text_size = 3,
    title = rq1y_twin_labels_clean[range_participation_outcomes[i]],
    caption = NULL,
    method = "none"  # p-values already adjusted above
  )
})

patchwork::wrap_plots(
  plots,
  ncol = 2)
  # Adjust ncol as needed

save_plot(
  "6_rq6_correlations", width = 12, height = 8)



```

[ðŸ“Š View Full Resolution Correlation Plots (PDF)](plots/pdfs/6_rq6_correlations.pdf)


## ACE Comparison

```{r}

# Extract ACE estimates and differences from all datasets
ace_estimates_list = lapply(variable_comparisons, function(x) x$ace_est_summary)
ace_differences_list = lapply(variable_comparisons, function(x) x$ace_diff_summary)

# Add dataset identifier to each
for(i in seq_along(ace_estimates_list)){
  ace_estimates_list[[i]]$dataset = rq1y_twin1[range_participation_outcomes[i]]
  ace_differences_list[[i]]$dataset = rq1y_twin1[range_participation_outcomes[i]]
}

# Combine into single dataframes
ace_estimates = do.call(rbind, ace_estimates_list)
ace_differences = do.call(rbind, ace_differences_list)

# Add readable dataset labels
ace_estimates$dataset_label = rq1y_twin_labels_clean[match(ace_estimates$dataset, rq1y_twin1)]
ace_differences$dataset_label = rq1y_twin_labels_clean[match(ace_differences$dataset, rq1y_twin1)]

```

### Table

```{r}

ace_differences_tbl = ace_differences  %>%
  group_by(sex, par, dataset) %>%
  mutate(
    pval_adj = stats::p.adjust(pval, method = "holm")
  ) %>%
  ungroup()

ace_differences_tbl %>%
  select(-starts_with("."), -n, -pd) %>%
  mutate(name_clean = rq6y_labels[match(name, rq6y)]) %>%
  select(dataset_label, name_clean, par, sex, y, ymin, ymax, pval, pval_adj) %>%
  arrange(sex, dataset_label, name_clean, par) %>%
  mutate(par = toupper(par)) %>%
  gt(groupname_col = "sex") %>%
  fmt_number(decimals = 3) %>%
  tab_row_group(
    label = "Male",
    rows = sex == "male"
  ) %>%
  tab_row_group(
    label = "Female",
    rows = sex == "female"
  ) %>%
  cols_hide(sex) %>%
  cols_label(
    dataset_label = "Dataset",
    name_clean = "Variable",
    par = "",
    y = "Diff",
    ymin = "Lower",
    ymax = "Upper",
    pval = md("p<sub>unadj</sub>"),
    pval_adj = md("p<sub>adj</sub>")
  ) %>%
  tab_spanner(
    label = "95% CI",
    columns = c(ymin, ymax)
  ) %>%
  tab_style(
    style = cell_fill(color = "#d5e8d4"),
    locations = cells_body(
      columns = everything(),
      rows = pval_adj < 0.05 & y > 0
    )
  ) %>%
  tab_style(
    style = cell_fill(color = "#f8cecc"),
    locations = cells_body(
      columns = everything(),
      rows = pval_adj < 0.05 & y < 0
    )
  ) %>%
  tab_footnote(
    footnote = "Difference = Attritioned âˆ’ Original. Adjusted P values are Bonferroni-Holm corrected within each sex, dataset, and parameter (A, C or E) group",
    locations = cells_column_labels(columns = pval_adj)
  ) %>%
  tab_options(
    table.font.size = px(9)
  )

```

### ACE Estimates Plot

```{r}

ace_estimates %>%
  mutate(
    name_clean = rq6y_labels[match(name, rq6y)],
    name_clean = factor(name_clean, levels = rq6y_labels),
    group = ifelse(group == "df1", "Attritioned", "Original"),
    group = factor(group, levels = c("Attritioned", "Original")),
    sex = str_to_title(sex),
    par = toupper(par),
    dataset_label = factor(dataset_label, levels = rq1y_twin_labels_clean[range_participation_outcomes])
  ) %>%
  ggplot(aes(x = group, y = y, fill = par)) +
  geom_col(position = "stack", alpha = 1) +
  facet_grid(sex + dataset_label ~ name_clean, switch = "x") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    strip.text = element_text(size = 8),
    strip.text.x = element_text(angle = 90, hjust = 1, vjust = .5),
    strip.text.y = element_text(angle = 0),
    strip.placement = "outside",
    panel.grid = element_blank()
  ) +
  labs(
    x = "Dataset",
    y = "Proportion",
    fill = "Component"
  ) +
  scale_fill_manual(values = c("A" = "#d73027", "C" = "#fee08b", "E" = "#4575b4")) +
  coord_cartesian(ylim = c(0, 1))

save_plot("6_rq6_ace_comparison", width = 10, height = 7)

```

[ðŸ“Š View Full Resolution ACE Comparison Plot (PNG)](plots/pngs/6_rq6_ace_comparison.png)

Although we see large-ish increases in the shared environment for depression symptoms in males, this is not significant even before multiple comparisons are corrected for. 

```{r}

ace_differences_tbl %>%
  filter(sex == "male" & name == "lcmfqt1") %>%
  select(-starts_with("."), -n, -pd) %>%
  mutate(name_clean = rq6y_labels[match(name, rq6y)]) %>%
  select(dataset_label, name_clean, par, sex, y, ymin, ymax, pval, pval_adj) %>%
  arrange(sex, dataset_label, name_clean, par) %>%
  mutate(par = toupper(par)) %>%
  gt(groupname_col = "sex") %>%
  fmt_number(decimals = 3) %>%
  tab_row_group(
    label = "Male",
    rows = sex == "male"
  ) %>%
  tab_row_group(
    label = "Female",
    rows = sex == "female"
  ) %>%
  cols_hide(sex) %>%
  cols_label(
    dataset_label = "Dataset",
    name_clean = "Variable",
    par = "",
    y = "Diff",
    ymin = "Lower",
    ymax = "Upper",
    pval = md("p<sub>unadj</sub>"),
    pval_adj = md("p<sub>adj</sub>")
  ) %>%
  tab_spanner(
    label = "95% CI",
    columns = c(ymin, ymax)
  ) %>%
  tab_style(
    style = cell_fill(color = "#d5e8d4"),
    locations = cells_body(
      columns = everything(),
      rows = pval_adj < 0.05 & y > 0
    )
  ) %>%
  tab_style(
    style = cell_fill(color = "#f8cecc"),
    locations = cells_body(
      columns = everything(),
      rows = pval_adj < 0.05 & y < 0
    )
  ) %>%
  tab_footnote(
    footnote = "Difference = Attritioned âˆ’ Original. Adjusted P values are Bonferroni-Holm corrected within each sex, dataset, and parameter (A, C or E) group",
    locations = cells_column_labels(columns = pval_adj)
  ) %>%
  tab_options(
    table.font.size = px(9)
  )

```


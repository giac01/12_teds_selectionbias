---
title: "RQ5: complete case analysis vs imputation analysis"
format: 
  html:
    embed-resources: true
    fig-width: 8
    fig-height: 8
    code-link: true
    code-fold: true
    code-tools: true
    df-print: paged
    toc: true
    grid:
      body-width: 900px
editor: source
---

# Load data


```{r}
#| output: false

source("0_load_data.R")

bootstrap_summary_df = readRDS(file = file.path("results", "5_bootstrap_summary_df.Rds"))
boot_compare_results = readRDS(file = file.path("results", "5_boot_compare_results.Rds"))
ace_comparisons      = readRDS(file = file.path("results", "5_ace_comparisons.Rds"))

imputed_mice = readRDS(file.path("results","5_1imputed_mice.Rds"))

```

## Load imputed dataset

```{r}

# Load the imputed dataset
df_rq5_imputed <- readRDS(file.path("data", "df_rq5_imputed.Rds"))

# Sample size

df_rq5_imputed %>%
  filter(.imp ==1) %>%
  nrow()

# Create comparison datasets - only rq5y variables
original_dataset <- df %>%
  filter(!(randomfamid %in% exclude_fams_onesib)) %>%
  filter(!(randomfamid %in% rq5_exclude_fams)) %>%
  filter(!(randomfamid %in% rq5_exclude_fams_2)) %>%                            # Exclude fams with less than 30% data on all imputed data (excluding baseline data)
  select(all_of(rq5y)) 

imputed_dataset <- df_rq5_imputed %>%
  select(all_of(rq5y))

```

# Descriptive stats

## Missingness plots

```{r}

df %>%
  select(amohqualn,all_of(rq5y)) %>%
  `colnames<-`(c("Y1: Mother Education", rq5y_labels_short)) %>%
  # select(rq5y) %>%
  # `colnames<-`(rq5y_labels_short) %>%
  as.data.frame() %>% # Note that this is needed for function to work - could improve? 
  gbtoolbox::plot_correlations(
    confidence_interval =  FALSE,
    sample_size = FALSE
  )

ggsave(filename = file.path("plots","5_3_plot_correlations_rq5y.pdf"), width = 5.3, height = 5.3)

df %>%
  select(amohqualn,all_of(rq5y)) %>%
  `colnames<-`(c("Y1: Mother Education", rq5y_labels_short)) %>%
  as.data.frame() %>%
  gbtoolbox::plot_missing_correlations(
    n_decimal_places = 2,
    cluster_variables = FALSE
    )

ggsave(filename = file.path("plots","5_3_plot_missing_correlations_rq5y.pdf"), width = 5.3, height = 5.3)

# takes a long time to run with all the vairables in 
if(FALSE){
df %>% 
  select(any_of(c(rq5y, rq5z))) %>%
  select(where(is.numeric)) %>%
  select(rq5y, everything()) %>%
  as.data.frame() %>%
  gbtoolbox::plot_missing_correlations(cluster_variables = FALSE, textadjust = 0) 
}

```


```{r}
#| include: false

# Variable check function
.variable_check = function(x, name = NULL){
  if (!is.null(name)) {
    var_name <- name
  } else {
    var_name <- deparse(substitute(x))
  }
  cat("Variable:", var_name, "\n")
  cat("Class:", class(x), "\n")
  cat("Label:", attr(x,"label"), "\n")
  print(table(x, useNA = "always"))
  cat("\n")
  return(invisible(NULL))
}

# # Check variable characteristics (subset for output)
# df %>%
#   select(any_of(rq5z)) %>%
#   mutate_if(is.numeric, ~ round(.x, 1)) %>%
#   # select(150:250) %>%
#   purrr::imap(~.variable_check(.x, .y))

# Check number of unique values per variable
df %>%
  select(any_of(rq5z)) %>%
  mutate_if(is.numeric, ~ round(.x, 1)) %>%
  apply(.,2, function(x) length(unique(x))) %>% 
  table()

```

## Missing data frequency plot

[Click here for full-size plot](plots/5_3_missing_data_frequency.pdf){target="_blank"}

```{r}

df %>%
  select(any_of(rq5z)) %>%
  select(!ends_with("2")) %>% # because the data is in a long format, we don't need the twin 2 variables! 
  apply(.,2,function(x) length(which(!is.na(x)))/length(x)) %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  `colnames<-`(c("var","percent_notmissing")) %>%
  mutate(
    # var       = factor(var, levels = rq5z),
    var_label = sapply(var, function(x) ifelse(!is.null(var_to_label(x)[[1]]), var_to_label(x), x)), 
    var_label = paste0(var_label, " (", var, ")"),
    var_label = factor(var_label, levels = var_label)
  ) %>%                                                                          #pull(var_label) %>% duplicated() %>% table()
  arrange(percent_notmissing) %>%
  
  ggplot(aes(x = percent_notmissing, y = var_label)) + 
  geom_col() +
  geom_vline(aes(xintercept=.2)) +
  theme_bw() +
  labs(x="Percent of not-missing data", y = NULL)
# 
ggsave(file.path("plots", "5_3_missing_data_frequency_auxillaryvars.pdf"), height = 32, width = 12)

df %>%
  select(any_of(rq5y)) %>%
  # filter(rowSums(!is.na(.)) > 0) %>% 
  apply(.,2,function(x) length(which(!is.na(x)))/length(x)) %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  `colnames<-`(c("var","percent_notmissing")) %>%
  mutate(var_label = factor(var, levels = rq5y, labels = rq5y_labels_short)) %>%
  ggplot(aes(x = percent_notmissing, y = var_label)) + 
  geom_col() +
  geom_vline(aes(xintercept=.2)) +
  geom_text(aes(label = paste0(round(percent_notmissing*100),"%")), hjust=1.2) +
  theme_bw() +
  labs(x="Percent of not-missing data", y = NULL)

ggsave(file.path("plots", "5_3_missing_data_frequency.pdf"), height = 32, width = 12)

df %>%
  select(cohort, any_of(rq5y)) %>%
  pivot_longer(cols = -cohort, names_to = "var", values_to = "value") %>%
  mutate(var = factor(var, levels = rq5y, labels = rq5y_labels_short)) %>%
  group_by(cohort, var) %>%
  summarise(
    total_n = dplyr::n(),
    not_missing_n = sum(!is.na(value)),
    percent_notmissing = not_missing_n / total_n,
    .groups = "drop"
  ) %>%
    mutate(
      # var_label = factor(var, levels = unique(var), labels = var_to_label(unique(var))),
      cohort = factor(cohort,
        levels = c("Cohort 4: twins born Sep-96 to Dec-96",
                   "Cohort 3: twins born Sep-95 to Aug-96",
                   "Cohort 2: twins born Sep-94 to Aug-95",
                   "Cohort 1: twins born Jan-94 to Aug-94"),
        labels = c("4", "3", "2", "1")
      )
    ) %>%
  ggplot(aes(x = percent_notmissing, y = var, fill = cohort)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_vline(aes(xintercept = 0.2), linetype = "dashed") +
  geom_text(
    aes(label = paste0(round(percent_notmissing*100), "%")),
    position = position_dodge(width = 0.8),
    hjust = -.2,
    size = 3
  ) +
  theme_bw() +
  labs(
    x = "Percent of not-missing data BY COHORT",
    y = NULL,
    fill = "Cohort"
  ) +
  theme(
    legend.position = "bottom",
    axis.text.y = element_text(size = 8)
  ) + 
  guides(fill = guide_legend(reverse = TRUE))

ggsave(file.path("plots", "5_3_missing_data_frequency_bycohort.pdf"), height = 13, width = 8)


``` 

## Descriptive table of imputation variables

```{r}
  get_levels_summary <- function(x) {
    if (is.factor(x)) {
      paste(levels(x), collapse = ", ")
    } else {
      unique_vals <- na.omit(unique(x))
      if (length(unique_vals) <= 6) {
        paste(unique_vals, collapse = ", ")
      } else {
        # paste(length(unique_vals), "unique values")
        paste("")
      }
    }
  }

# List of all variables for imputation
df_rq5 = df %>%
  select(any_of(rq5z))

# Descriptive information on each imputed variable
impute_df = data.frame(
  var   = colnames(df_rq5),
  label = as.character(sapply(df_rq5, function(x) attr(x, "label"))),
  levels = map_chr(df_rq5, get_levels_summary),
  class = as.character(sapply(df_rq5, function(x) class(x))),
  perc_not_missing = as.numeric(sapply(df_rq5, function(x) round(length(which(!is.na(x)))/length(x)*100))),
  sd    = round(as.numeric(sapply(df_rq5, function(x) sd(as.numeric(x), na.rm = TRUE) )),2),
  distinct_categories = as.numeric(sapply(df_rq5, function(x) length(na.omit(unique(x)))))
)

impute_df <- impute_df %>%
  mutate(variable_year = case_when(
    str_starts(var, "a") ~ "Year 1 (1st Contact)",
    str_starts(var, "b") ~ "Year 2",
    str_starts(var, "c") ~ "Year 3",
    str_starts(var, "d") ~ "Year 4",
    str_starts(var, "g") ~ "Year 7",
    str_starts(var, "h") ~ "Year 8",
    str_starts(var, "i") ~ "Year 9",
    str_starts(var, "j") ~ "Year 10",
    str_starts(var, "l") ~ "Year 12",
    str_starts(var, "n") ~ "Year 14",
    str_starts(var, "p") ~ "Year 16",
    str_starts(var, "r") ~ "Year 18",
    str_starts(var, "u") ~ "Year 21",
    str_starts(var, "z") ~ "Year 26",
    TRUE ~ "Other"
  ))


impute_df %>%
  arrange(perc_not_missing) %>%
  knitr::kable()

```

## Missing data proportions by group

Interestingly, MZ twins have more missing data than DZ twins 

```{r}

# Check proportion of missing data by sexzyg group
df %>%
  select(sexzyg, any_of(rq5y)) %>%
  group_by(sexzyg) %>%
  summarise(
    n = dplyr::n(),
    total_cells = dplyr::n() * length(rq5y),
    missing_cells = sum(is.na(c_across(any_of(rq5y)))),
    overall_prop_missing = missing_cells / total_cells,
    .groups = "drop"
  ) %>%
  knitr::kable(digits = 2)

# Gives the same results! 
# df %>%
#   select(sexzyg, any_of(rq5y)) %>%
#   pivot_longer(cols = any_of(rq5y)) %>%
#   group_by(sexzyg) %>%
#   summarise(
#     total_cells = length(value),
#     missing_cells = sum(is.na(value)),
#     overall_prop_missing = missing_cells / total_cells,
#     .groups = "drop"
#   ) %>%
#   knitr::kable(digits =2)

```

### Number of missing cells per participant for rq5y variables

For the variables `r var_to_label(rq5y)`, how many cells is each participant missing. 

```{r}

df %>%
  select(any_of(rq5y)) %>%
  mutate(missing_count = rowSums(is.na(.))) %>%
  select(missing_count) %>%
  count(missing_count) %>%
  mutate(
    percent = round(n / sum(n) * 100, 1),
    total_vars = length(rq5y)
  ) %>%
  knitr::kable(
    col.names = c("# Missing Variables Per Pps", "N pps", "% pps", "Total Variables"),
    caption = "How many missing cells does each participant have on the key outcome variables? "
  )

```


## Missing data flux

```{r}


df %>%
  select(any_of(c(rq1x,rq5z))) %>%
  mice::fluxplot()


```


## How well can we predict missingness in the outcomes? 

```{r}



```

# Compare univariate distributions (means, variances, pdfs)


### Test for reliability of imputation

 to add 
 
```{r}



```

### Plot illustration showing how imputation works

```{r}

set.seed(10)
df_rq5_imputed %>%
  filter(randomtwinid2 %in% sample(.$randomtwinid2,30)) %>%
  mutate(id = factor(randomtwinid2, labels = paste0("pps",1:length(unique(.$randomtwinid2))))) %>%
  mutate(value = lcg1) %>%
  ggplot(aes(x = value)) + 
  geom_histogram(bins = 10) + 
  facet_wrap(~id, ncol = 5, scales = "fixed") + 
  labs(
    y = "General Cognitive Ability scores at age 12 (standardised; lcg1)",
    # title = NULL,
    x = NULL
  ) + 
  theme_bw()

ggsave(file = file.path("plots", "5_3_imputation_distribution.pdf"), width = 9, height = 6)

df$lcg1 %>% sd(na.rm  =T)

```

## Compare univariate distributions

```{r}

# Calculate comparisons using existing functions
smd_values        = compare_smd(imputed_dataset, original_dataset)
md_values         = compare_md(imputed_dataset, original_dataset)
var_values        = compare_var(imputed_dataset, original_dataset)
hellinger_values  = compare_hellinger(imputed_dataset, original_dataset)
var_values        = compare_var(imputed_dataset, original_dataset)

# Create results dataframe
comparison_results <- data.frame(
  variable = names(original_dataset),
  label    = var_to_label(names(original_dataset)),
  smd = smd_values,
  md = md_values,
  var = var_values,
  hellinger = hellinger_values,
  stringsAsFactors = FALSE
)
# Display results
comparison_results %>%
  select(-variable) %>%
  arrange(desc(abs(smd))) %>%
  knitr::kable(caption = "Comparison of Original vs Imputed Data (POOLED ANALYSIS - NO CIS)", digits = 2)

```


## Plot distribution comparisons

[Click here for full-size plot](plots/5_rq5_histogram_comparison.pdf){target="_blank"}


```{r}

# Create long format data for plotting
original_long <- original_dataset %>%
  mutate(dataset = "Original") %>%
  pivot_longer(cols = -dataset, names_to = "variable", values_to = "value")

imputed_long <- imputed_dataset %>%
  # slice(1:1000) %>%
  mutate(dataset = "Imputed") %>%
  pivot_longer(cols = -dataset, names_to = "variable", values_to = "value")

combined_long <- bind_rows(original_long, imputed_long) %>%
  filter(!is.na(value)) %>%
  mutate(
    variable_label = factor(variable, levels = rq5y, labels = rq5y_labels_short)
  )



combined_long %>%
  ggplot(aes(x = value, fill = dataset)) +
  geom_histogram(aes(y = after_stat(density * 100)),
                 alpha = .7, position = "identity", bins = 10,
                 color = "black", size = 0.2) +
  facet_wrap(~variable_label, scales = "free", ncol = 4) +
  scale_fill_manual(values = c("Original" = "#1f77b4", "Imputed" = "#ff7f0e")) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 8, face = "bold"),
    legend.position = "bottom",
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "grey98")
  ) +
  labs(
    title = "Distribution Comparison: Original vs Imputed Data",
    x = "Value",
    y = "Density (%)",
    fill = "Dataset"
  )

ggsave(file.path("plots", "5_rq5_histogram_comparison.pdf"), width = 12, height = 9)

```

## Plot comparison statistics

[Click here for full-size plot](plots/5_rq5_distribution_comparison.pdf){target="_blank"}

```{r}

outcome_order <- bootstrap_summary_df %>%
    mutate(outcome = rq5y_labels_short[match(.$outcome, rq5y)]) %>%
    filter(parameter == "smd") %>%
    arrange((abs(y))) %>%
    mutate(outcome = str_remove(outcome, "1$")) %>%
    pull(outcome)

  bootstrap_summary_df %>%
    # Clean up outcome labels (remove the "1" suffix)
    mutate(outcome = rq5y_labels_short[match(.$outcome, rq5y)]) %>%
    # Create ordered factors
    mutate(
      # Order parameters as requested
      parameter = factor(parameter, levels = c("smd", "md", "var", "h")),
      # Order outcomes based on SMD values
      outcome = factor(outcome, levels = outcome_order)
    ) %>%
    ggplot(aes(x = outcome, y = y)) +
    geom_col(aes(fill = parameter), alpha = 1) +
    geom_errorbar(aes(ymin = ymin, ymax = ymax), width = 0.3) +
    geom_hline(yintercept = 0, col = "black", linetype = "dashed") +
    facet_wrap(~ parameter, scales = "free_x", nrow = 1) +
    coord_flip() +
    labs(
      title = "Bootstrap Differences by Parameter",
      subtitle = "Imputed vs Original Data",
      x = "Outcome Variable",
      y = "Effect Size",
      fill = "Parameter"
    ) +
    theme_minimal() +
    theme(
      legend.position = "none",
      strip.text = element_text(face = "bold"),
      axis.text.y = element_text(size = 8)
    ) +
    scale_fill_discrete() 

ggsave(file.path("plots", "5_rq5_distribution_comparison.pdf"), width = 9, height = 6)

```

# Compare correlations


## Clean results

```{r}

boot_compare_cor_df = do.call(rbind, lapply(seq_along(boot_compare_results), function(i) {
  result_df = t(as.data.frame(boot_compare_results[[i]]$cor_resid))
  result_df = data.frame(.imp = i, .boot = 1:nrow(result_df), result_df, row.names = NULL)
  return(result_df)
}))

boot_compare_srmr_df = do.call(rbind, lapply(seq_along(boot_compare_results), function(i) {
  result_df = t(as.data.frame(boot_compare_results[[i]]$srmr))
  result_df = data.frame(.imp = i, .boot = 1:nrow(result_df), srmr = result_df, row.names = NULL)
  return(result_df)
}))

boot_correlation_results = boot_compare_cor_df %>%
  select(-.imp, -.boot) %>%
  apply(.,2, function(xx) .mean_qi_pd(xx)) %>%
  list_rbind()

boot_srmr_results = boot_compare_srmr_df %>%
  pull(srmr) %>%
  .mean_qi_pd()

```

## Results

[Click here for full-size plot](plots/5_rq5_correlation_differences.pdf){target="_blank"}

```{r}

# # Calculate SRMR using existing function
# srmr <- calc_srmr2(original_dataset, imputed_dataset)
# 
# # Also calculate correlation matrices for visualization
# cor_original <- cor(original_dataset, use = "complete.obs")
# cor_imputed <- cor(imputed_dataset, use = "complete.obs")
# 
# cat("SRMR (correlation structure difference):", round(srmr, 4), "\n")
# cat("SRMR < 0.05 indicates good fit\n")
# cat("SRMR < 0.08 indicates acceptable fit\n")

# Prepare correlation data for plotting (following RQ2 approach)
# Calculate correlation residuals 
# cor_residuals <- compare_correlation(original_dataset, imputed_dataset)



# Create matrix positions for correlation plot (adapted from RQ2)
test_correlation_matrix = matrix(
  nrow = length(rq5y),
  ncol = length(rq5y)
)

for(i in seq_along(rq5y)){
  for(j in seq_along(rq5y)){
    test_correlation_matrix[i,j] = paste(rq5y[i], rq5y[j], collapse = " ")
  }
}

x = test_correlation_matrix[lower.tri(test_correlation_matrix)]
x_var = str_extract(x, "^\\S+")
y_var = str_extract(x, "\\S+$")

rm(test_correlation_matrix, x)

# Create correlation comparison dataframe
correlation_comparison <- data.frame(
  x_var = x_var,
  y_var = y_var,
  boot_correlation_results,
  stringsAsFactors = FALSE
)

# Set variables for plotting function
rq2y <- rq5y  # Temporary assignment for compatibility with plotting function
rq2y_labels_short <- rq5y_labels_short

# Plot correlation differences using RQ2 approach
# debug(plot_lower_triangular_matrix2)

correlation_plot <- correlation_comparison %>%
  plot_lower_triangular_matrix2(
    .,
    variables   = rq5y,
    labels      = rq5y_labels_short,
    title       = "Correlation Differences (Imputed - Original)",
    caption     = "RQ5: Imputation vs Original Data",
    p_col       = "pval",
    p_threshold = 1.0  
  )

ggsave(file.path("plots", "5_rq5_correlation_differences.pdf"), width = 10, height = 8)

# Clean up temporary variables
rm(rq2y, rq2y_labels_short)


# cor.test(imputed_dataset$uc)

```


## Ignore for now

```{r}
#| include: false

# cbind(rq5y, rq5y_labels_short, var_to_label(rq5y))
# 
# cor.test(df$ucgt1, df$pcg1)
# 
# missing_data_pps = df %>%
#   filter(is.na(ucgt1) | is.na(pcg1)) %>%
#   mutate(
#     randomtwinid2 = paste0(randomfamid, random)
#   ) %>% 
#   pull(randomtwinid2)
# 
# df_rq5_imputed %>%
#   mutate(
#     missing = .$randomtwinid2 %in% missing_data_pps
#   ) %>%
#   filter(.imp ==1) %>%
#   ggplot(aes(x = ucgt1, y = pcg1, col = missing)) + 
#   geom_point(alpha = .1) + 
#   facet_wrap(~missing)
# 
#   df_rq5_imputed %>%
#     filter(.imp == 1) %>%
#     mutate(
#       missing = randomtwinid2 %in% missing_data_pps
#     ) %>%
#     group_by(missing) %>%
#     summarise(
#       correlation = cor(ucgt1, pcg1, use = "pairwise.complete.obs"),
#       .groups = "drop"
#     )
# 
# cor.test(original_dataset$ucgt1, original_dataset$pcg1)
# cor.test(imputed_dataset$ucgt1, imputed_dataset$pcg1)
# 



```


# ACE Model Comparisons

```{r}

ace_comparisons$boot_results_differences_summary %>%
  mutate(
    outcome = var_to_label(paste0(outcome,"1")),
    outcome = factor(outcome, levels = var_to_label(rq5y), labels = rq5y_labels_short)
    ) %>%
  ggplot(aes(y = y, ymin = ymin, ymax = ymax, x = outcome, group = parameter, fill = parameter)) + 
  geom_col(position = "dodge") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))


ace_comparisons$boot_results_original_summary %>%
  select(outcome, parameter, y) %>%
  mutate(
    outcome = var_to_label(paste0(outcome,"1")),
    outcome = factor(outcome, levels = var_to_label(rq5y), labels = rq5y_labels_short)
    ) %>%
  arrange(outcome) %>%
  pivot_wider(names_from = parameter, values_from = y) %>%
  knitr::kable(digits =2)


ace_comparisons$boot_results_imputed_summary %>%
  select(outcome, parameter, y) %>%
  mutate(
    outcome = var_to_label(paste0(outcome,"1")),
    outcome = factor(outcome, levels = var_to_label(rq5y), labels = rq5y_labels_short)
    ) %>%
  arrange(outcome) %>%
  pivot_wider(names_from = parameter, values_from = y) %>%
  knitr::kable(digits =2)
  

```


Lets try to understand what is happening to the correlations... 

```{r}


```


# Supplementary Plots

## Comparison of sample size pre- and post-imputation

```{r}
p1 = df %>%
  select(all_of(rq5y)) %>%
  `colnames<-`(c(rq5y_labels_short)) %>%
  # select(rq5y) %>%
  # `colnames<-`(rq5y_labels_short) %>%
  as.data.frame() %>% # Note that this is needed for function to work - could improve? 
  gbtoolbox::plot_correlations(
    confidence_interval =  FALSE,
    sample_size = TRUE,
    textadjust = 1
  ) + 
  labs(title = "Original (non-imputed data)")

p2 = df_rq5_imputed %>%
  filter(.imp == 1) %>%
  select(all_of(rq5y)) %>%
  `colnames<-`(c(rq5y_labels_short)) %>%
  # select(rq5y) %>%
  # `colnames<-`(rq5y_labels_short) %>%
  as.data.frame() %>% # Note that this is needed for function to work - could improve? 
  gbtoolbox::plot_correlations(
    confidence_interval =  FALSE,
    sample_size = TRUE,
    textadjust = 1
  ) +
  labs(title = "Imputed data")

p1 + p2

ggsave(filename = file.path("plots","5_3_correlation_comparison.pdf"), width = 5.3*2, height = 5.3)



df_rq5_imputed %>%
  filter(.imp == 1) %>%
  sapply(., function(x) length(which(!is.na(x))))


df_rq5_imputed$ncg1

```

# Check for convergence of algorithm 

```{r}

imputed_mice %>% length()

plot(imputed_mice[[1]], y = rq5y, layout = c(4,6))

plot(imputed_mice[[3]], y = rq5y, layout = c(4,6))


```










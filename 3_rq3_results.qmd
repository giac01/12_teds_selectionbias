---
title: "RQ3"
format: 
  html:
    fig-width: 8
    fig-height: 8
    code-link: true
    code-fold: true
    code-tools: true
    df-print: paged
    toc: true
    grid:
      body-width: 900px
editor: source
---

# Load data

We could stratify the data by whether they have participated recently?

```{r}
#| output: false
source("0_load_data.R")
```

# Create participation variables

```{r}
df$age21_participate1 = !is.na(df$u1csdqprot1) | !is.na(df$u1csdqpert1) | !is.na(df$u1csdqhypt1) | !is.na(df$u1csdqcont1) | !is.na(df$u1csdqemot1)

df$age21_participate2 = !is.na(df$u1csdqprot2) | !is.na(df$u1csdqpert2) | !is.na(df$u1csdqhypt2) | !is.na(df$u1csdqcont2) | !is.na(df$u1csdqemot2)

df$age26_participate1 = !is.na(df$zmhsdqprot1) | !is.na(df$zmhsdqpert1) | !is.na(df$zmhsdqhypt1) | !is.na(df$zmhsdqcont1) | !is.na(df$zmhsdqemot1)

df$age26_participate2 = !is.na(df$zmhsdqprot2) | !is.na(df$zmhsdqpert2) | !is.na(df$zmhsdqhypt2) | !is.na(df$zmhsdqcont2) | !is.na(df$zmhsdqemot2)

table(df$age21_participate1)
table(df$uteds21data)
table(df$age21_participate1, is.na(df$u1cmfqt1))
table(df$age26_participate1)
table(df$zmhdata)
```

# Participation Rates by Sex and Zygosity

```{r}
# Age 21 participation rates by sexzyg
df %>%
  filter(random == 1) %>%
  group_by(sexzyg) %>%
  summarise(
    n_pairs = dplyr::n(),
    twin1_participation_rate = mean(age21_participate1, na.rm = TRUE),
    twin2_participation_rate = mean(age21_participate2, na.rm = TRUE),
    both_participate_rate = mean(age21_participate1 & age21_participate2, na.rm = TRUE),
    either_participate_rate = mean(age21_participate1 | age21_participate2, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  knitr::kable(
    caption = "Age 21 Participation Rates by Sex and Zygosity",
    digits = 3
  )

# Age 26 participation rates by sexzyg
df %>%
  filter(random == 1) %>%
  group_by(sexzyg) %>%
  summarise(
    n_pairs = dplyr::n(),
    twin1_participation_rate = mean(age26_participate1, na.rm = TRUE),
    twin2_participation_rate = mean(age26_participate2, na.rm = TRUE),
    both_participate_rate = mean(age26_participate1 & age26_participate2, na.rm = TRUE),
    either_participate_rate = mean(age26_participate1 | age26_participate2, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  knitr::kable(
    caption = "Age 26 Participation Rates by Sex and Zygosity",
    digits = 3
  )
```

# Age 21 Twin Correlations

SHOULD USE ALTERNATE CORRELATION MATRIX FOR BINARY VARIABLES! 

```{r}

df %>%
  filter(random == 1) %>%
  group_by(sexzyg) %>%
  summarise(
    correlation = cor(age21_participate1, age21_participate2, use = "complete.obs"),
    n = sum(!is.na(age21_participate1) & !is.na(age21_participate2)),
    .groups = "drop"
  ) %>% 
  knitr::kable(
    caption = "Twin Participation Correlations at Age 21",
    digits = 2
  )
```

# Age 21 ACE Model Results

```{r}
df %>%
  calc_ace(var = "age21_participate") %>%
  knitr::kable(
    caption = "ACE Estimates for Participation at Age 21 (Full Sample)",
    digits = 2)

df %>%
  filter(sex1 == 1) %>%
  calc_ace(var = "age21_participate") %>%
  knitr::kable(
    caption = "ACE Estimates for Participation at Age 21 (Males)",
    digits = 2)

df %>%
  filter(sex1 == 0) %>%
  calc_ace(var = "age21_participate") %>%
  knitr::kable(
    caption = "ACE Estimates for Participation at Age 21 (Females)",
    digits = 2)
```

# Age 26 Twin Correlations

```{r}


df %>%
  filter(random == 1) %>%
  group_by(sexzyg) %>%
  summarise(
    correlation = cor(age26_participate1, age26_participate2, use = "complete.obs"),
    n = sum(!is.na(age26_participate1) & !is.na(age26_participate2)),
    .groups = "drop"
  ) %>% 
  knitr::kable(
    caption = "Twin Participation Correlations at Age 26",
    digits = 2
  )
```

# Age 26 ACE Model Results

```{r}
df %>%
  calc_ace(var = "age26_participate") %>%
  knitr::kable(
    caption = "ACE Estimates for Participation at Age 26 (Full Sample)",
    digits = 2)

df %>%
  filter(sex1 == 1) %>%
  calc_ace(var = "age26_participate") %>%
  knitr::kable(
    caption = "ACE Estimates for Participation at Age 26 (Males)",
    digits = 2)

df %>%
  filter(sex1 == 0) %>%
  calc_ace(var = "age26_participate") %>%
  knitr::kable(
    caption = "ACE Estimates for Participation at Age 26 (Females)",
    digits = 2)
```

# Binary Variable Correlations

Using tetrachoric correlation for binary variables, which is more appropriate than Pearson correlation for dichotomous data.

```{r}
library(psych)

# Age 21 tetrachoric correlations
df %>%
  filter(random == 1) %>%
  group_by(sexzyg) %>%
  summarise(
    tetrachoric_cor = tetrachoric(cbind(age21_participate1, age21_participate2))$rho[1,2],
    phi_coefficient = phi(table(age21_participate1, age21_participate2)),
    n = sum(!is.na(age21_participate1) & !is.na(age21_participate2)),
    .groups = "drop"
  ) %>% 
  knitr::kable(
    caption = "Binary Variable Correlations for Age 21 Participation",
    digits = 3
  )

# Age 26 tetrachoric correlations  
df %>%
  filter(random == 1) %>%
  group_by(sexzyg) %>%
  summarise(
    tetrachoric_cor = tetrachoric(cbind(age26_participate1, age26_participate2))$rho[1,2],
    phi_coefficient = phi(table(age26_participate1, age26_participate2)),
    n = sum(!is.na(age26_participate1) & !is.na(age26_participate2)),
    .groups = "drop"
  ) %>% 
  knitr::kable(
    caption = "Binary Variable Correlations for Age 26 Participation",
    digits = 3
  )
```

# ACE Model Results Using Tetrachoric Correlations

## Age 21 ACE Model Results (Tetrachoric)

```{r}
df %>%
  calc_ace_binary(var = "age21_participate") %>%
  knitr::kable(
    caption = "ACE Estimates for Participation at Age 21 Using Tetrachoric Correlations (Full Sample)",
    digits = 3)

df %>%
  filter(sex1 == 1) %>%
  calc_ace_binary(var = "age21_participate") %>%
  knitr::kable(
    caption = "ACE Estimates for Participation at Age 21 Using Tetrachoric Correlations (Males)",
    digits = 3)

df %>%
  filter(sex1 == 0) %>%
  calc_ace_binary(var = "age21_participate") %>%
  knitr::kable(
    caption = "ACE Estimates for Participation at Age 21 Using Tetrachoric Correlations (Females)",
    digits = 3)
```

## Age 26 ACE Model Results (Tetrachoric)

```{r}
df %>%
  calc_ace_binary(var = "age26_participate") %>%
  knitr::kable(
    caption = "ACE Estimates for Participation at Age 26 Using Tetrachoric Correlations (Full Sample)",
    digits = 3)

df %>%
  filter(sex1 == 1) %>%
  calc_ace_binary(var = "age26_participate") %>%
  knitr::kable(
    caption = "ACE Estimates for Participation at Age 26 Using Tetrachoric Correlations (Males)",
    digits = 3)

df %>%
  filter(sex1 == 0) %>%
  calc_ace_binary(var = "age26_participate") %>%
  knitr::kable(
    caption = "ACE Estimates for Participation at Age 26 Using Tetrachoric Correlations (Females)",
    digits = 3)
```

# Supplementary: Contingency Tables

## Age 21 Twin Participation Contingency Table

```{r}
table_age21 = df %>%
  filter(random == 1) %>%
  select(age21_participate1, age21_participate2) %>%
  table() %>%
  addmargins()

dimnames(table_age21) = list(
  "Twin 1" = c("No", "Yes", "Sum"),
  "Twin 2" = c("No", "Yes", "Sum")
)

table_age21 %>%
  knitr::kable(
    caption = "Contingency Table: Age 21 Twin Participation (Twin 1 vs Twin 2)"
  )
```

## Age 26 Twin Participation Contingency Table

```{r}
table_age26 = df %>%
  filter(random == 1) %>%
  select(age26_participate1, age26_participate2) %>%
  table() %>%
  addmargins()

dimnames(table_age26) = list(
  "Twin 1" = c("No", "Yes", "Sum"),
  "Twin 2" = c("No", "Yes", "Sum")
)

table_age26 %>%
  knitr::kable(
    caption = "Contingency Table: Age 26 Twin Participation (Twin 1 vs Twin 2)"
  )
```

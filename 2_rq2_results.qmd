---
title: "RQ2: artificialy attritioned datasets"
format: 
  html:
    embed-resources: true
    fig-width: 8
    fig-height: 8
    code-link: true
    code-fold: true
    code-tools: true
    df-print: paged
    toc: true
    grid:
      body-width: 900px
editor: source
---

```{r}
#| output: false

source("0_load_data.R")
rm(rq1y, rq1y_labels, rq1y_labels_clean)

## Only keep time points where all participants were eligible 

remove_timepoints = c("btwdata","ctwdata", "gcdata","icdata","jcdata","pcwebdata") 
remove_timepoints = match(remove_timepoints, rq1y_twin)

rq1y_twin                         = rq1y_twin[-remove_timepoints]
rq1y_twin1                        = rq1y_twin1[-remove_timepoints]
rq1y_twin2                        = rq1y_twin2[-remove_timepoints]
rq1y_twin_labels                  = rq1y_twin_labels[-remove_timepoints]
rq1y_twin_labels_clean            = rq1y_twin_labels_clean[-remove_timepoints]
rq1y_twin_labels_clean_extrashort = rq1y_twin_labels_clean_extrashort[-remove_timepoints]


```

# Descriptive Statistics

```{r}

df %>%
  select(all_of(rq2y)) %>%
  # select(where(is.numeric)) %>%
  # mutate(across(everything(), as.character)) %>%
  pivot_longer(cols = everything()) %>%
  ggplot(aes(x=value)) +
  geom_histogram() +
  facet_wrap(~name, ncol = 4, scales = "free")


df %>%
  select(all_of(rq2y)) %>%
  apply(.,2,function(x) length(unique(x)))

```

# Create Attritioned Datasets

To remove participants, I've set the rows to NA rather than remove the rows, so all the datasets should have the same length.

```{r}

attritioned_datasets = list()

for (i in seq_along(rq1y_twin1)){
  
  filter = as.numeric(df[[rq1y_twin1[i]]])==0 # 1 = present (Y), 2 = not-present (N)
  
  attritioned_datasets[[i]] = df %>% 
    select(all_of(rq2y))
  
  attritioned_datasets[[i]][filter,] = NA
  
}

original_dataset = df %>%
  select(all_of(rq2y))


```

# Compare univariate distributions

## Load Results

I ran the bootstrapped analyses in the script [2_rq2_run_bootstrapping.R](2_rq2_run_bootstrapping.R){target="_blank"}.

```{r}
original_variances = sapply(rq2y, function(x) stats::var(df[[x]], na.rm = TRUE))

variable_comparisons    = readRDS(file = file.path("results", "2_variable_comparisons.Rds"))

variable_comparisons_df0 = readRDS(file = file.path("results", "2_variable_comparisons_df.Rds"))

# variable_comparisons_df = do.call("rbind.data.frame", variable_comparisons_df)

readRDS(file = file.path("results", "2_variable_comparisons_df.Rds")) %>% head()

variable_comparisons_df = variable_comparisons_df0 %>% 
  mutate(
    dataset = rq1y_twin_labels_clean[match(.$dataset, rq1y_twin1)],
    variable = rq2y_labels_short[match(.$variable, rq2y_labels)]
    ) %>%
  # Rescale variance vlalues
  pivot_longer(cols = starts_with("y")) %>%
  mutate(
    var_constant = original_variances[match(.$variable,rq2y_labels_short)],
    value = case_when(
      stat == "var" ~ value / var_constant,
      TRUE ~ value
    )
  ) %>%
  select(-var_constant) %>%
  pivot_wider(
    values_from = value, 
    names_from  = name
    # id_cols     = c("dataset", "variable")
  ) %>%
  group_by(dataset, stat) %>%
  mutate(
    pval_adj = stats::p.adjust(pval, method = "holm")
  )

# Data checks 

# variable_comparisons_df %>% 
#   filter(stat == "smd" & dataset == "zmhdata") %>%
#   mutate(
#     pval_adj2 = stats::p.adjust(pval, method = "holm")
#   ) 

# variable_comparisons_df %>%
#   filter(stat == "smd") %>%
#   print(n=120)

# 
# x = variable_comparisons[[11]]$bootstrap_iter$smd[,1]
# 
# table(x>0) / sum(table(x))
# 
# bayestestR::pd(x) %>% bayestestR::pd_to_p(.)

```

## Create GT Results table

```{r}

variable_comparisons_df %>% 
  filter(stat!="h") %>%
  select(-starts_with("."),-pd, -pval) %>%
  pivot_wider(
    names_from = "stat",
    values_from = c("y","ymin","ymax","pval_adj"),
    id_cols = c("variable", "dataset")
  ) %>%
  dplyr::rename( Outcome = "variable") %>%
  gt(groupname_col = "dataset") %>%
  tab_options(
    table.width = px(800)
    # table.border.top.style = "none",
    # table.border.bottom.style = "none",
    # column_labels.border.bottom.style = "solid",
    # column_labels.border.bottom.width = px(1),
    # column_labels.border.bottom.color = "black",
    # table_body.border.bottom.style = "none",
    # table_body.vlines.style = "none",
    # row_group.border.bottom.style = "none"
  ) %>%
  
  # Create column spanners (nested headers)
  tab_spanner(
    label = "Mean Difference",
    columns = c(y_md, ymin_md, ymax_md, pval_adj_md)
  ) %>%
  tab_spanner(
    label = "Standardized Mean Difference", 
    columns = c(y_smd, ymin_smd, ymax_smd, pval_adj_smd)
  ) %>%
  tab_spanner(
    label = "Variance % Change",
    columns = c(y_var, ymin_var, ymax_var, pval_adj_var)
  ) %>%
  
  # Rename columns under each spanner
  cols_label(
    y_md = "Est", ymin_md = "LB", ymax_md = "UB", pval_adj_md = "p",
    y_smd = "Est", ymin_smd = "LB", ymax_smd = "UB", pval_adj_smd = "p", 
    y_var = "Est", ymin_var = "LB", ymax_var = "UB", pval_adj_var = "p"
  ) %>%
  
  # Format numbers
  fmt(
    columns = !contains("var") & !contains("Outcome"),
    fns = function(x) {gbtoolbox::apa_num(x, n_decimal_places = 3)}
  ) %>% 
  fmt(
    columns = "pval_adj_var",
    fns = function(x) {gbtoolbox::apa_num(x, n_decimal_places = 3)}
  ) %>% 
  fmt_percent(
    columns = c("y_var", "ymin_var","ymax_var"),
    decimals = 2,
    drop_trailing_zeros = FALSE,
    drop_trailing_dec_mark = FALSE
  ) %>%
  # Styling - uniform font size
  tab_style(
    style = cell_text(size = px(10)),
    locations = cells_column_spanners()
  ) %>%
  tab_style(
    style = cell_text(size = px(10)),
    locations = cells_body()
  ) %>%
  tab_style(
    style = cell_text(size = px(10), align = "center"),
    locations = cells_row_groups()
  ) %>%
  tab_style(
    style = cell_text(size = px(10)),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_text(size = px(10)),
    locations = cells_footnotes()
  ) %>%
  
  # Highlight significant results - positive effects (light green)
  tab_style(
    style = cell_fill(color = "#d5e8d4"),  # Light green for positive effects
    locations = cells_body(
      columns = c(y_md, ymin_md, ymax_md, pval_adj_md),
      rows = pval_adj_md < 0.05 & y_md > 0
    )
  ) %>%
  tab_style(
    style = cell_fill(color = "#d5e8d4"),  # Light green for positive effects
    locations = cells_body(
      columns = c(y_smd, ymin_smd, ymax_smd, pval_adj_smd),
      rows = pval_adj_smd < 0.05 & y_smd > 0
    )
  ) %>%
  tab_style(
    style = cell_fill(color = "#d5e8d4"),  # Light green for positive effects
    locations = cells_body(
      columns = c(y_var, ymin_var, ymax_var, pval_adj_var),
      rows = pval_adj_var < 0.05 & y_var > 0
    )
  ) %>%
  
  # Highlight significant results - negative effects (light red)
  tab_style(
    style = cell_fill(color = "#f8cecc"),  # Light red for negative effects
    locations = cells_body(
      columns = c(y_md, ymin_md, ymax_md, pval_adj_md),
      rows = pval_adj_md < 0.05 & y_md < 0
    )
  ) %>%
  tab_style(
    style = cell_fill(color = "#f8cecc"),  # Light red for negative effects
    locations = cells_body(
      columns = c(y_smd, ymin_smd, ymax_smd, pval_adj_smd),
      rows = pval_adj_smd < 0.05 & y_smd < 0
    )
  ) %>%
  tab_style(
    style = cell_fill(color = "#f8cecc"),  # Light red for negative effects
    locations = cells_body(
      columns = c(y_var, ymin_var, ymax_var, pval_adj_var),
      rows = pval_adj_var < 0.05 & y_var < 0
    )
  ) %>%
  
  # Add footnotes
  tab_footnote(
    footnote = md("<em>Note.</em> Est = Estimate, LB = Lower Bound 95% Confidence Interval, UB = Upper Bound 95% Confidence Interval. Significant (p<sub>Bonferroni-Holm</sub>) effects are highlighted in green (increases) or red (decreases)."),
    # locations = cells_column_spanners(),
    placement = "right"
  ) %>%
  tab_footnote(
    footnote = "P values are Bonferroni-Holm adjusted within each participation group",
    locations = cells_column_labels(columns = contains("pval_adj")),
    placement = "right"
  ) %>%
  tab_footnote(
    footnote = md("Standardized mean difference = (Mean<sub>original</sub> - Mean<sub>attritioned</sub>) / SD<sub>original</sub>"),
    locations = cells_column_spanners(spanners = "Standardized Mean Difference"),
    placement = "right"
  ) %>%
    tab_footnote(
    footnote = md("Percentage change = (Var<sub>attritioned</sub> - Var<sub>original</sub>) / Var<sub>original</sub>"),
    locations = cells_column_spanners(spanners = "Variance % Change"),
    placement = "right"
  ) %>%
  opt_footnote_marks(marks = c("*", "â€ ","â€¡"))


```

## Create circular heatmaps for changes in means and variances

### Standardised Mean Differences 

```{r}
  # Create circular heatmap for SMD
   heatmap_data_smd = variable_comparisons_df %>%
    filter(stat == "smd") %>%
    mutate(
      outcome_labeled = rq1y_twin_labels_clean_extrashort[match(dataset,rq1y_twin_labels_clean)],
      outcome_labeled = factor(outcome_labeled, levels = rq1y_twin_labels_clean_extrashort),
      Variables_wrapped = str_wrap(variable, width = 8),
      # Set fill value to NA if not significant, otherwise keep original sign
      fill_value = case_when(
        pval_adj < 0.05 ~ y,
        TRUE ~ NA
      )
    ) %>%
    # Order variables by number of significant effects
    group_by(variable) %>%
    mutate(n_significant = sum(pval_adj < 0.05)) %>%
    ungroup() %>%
    mutate(
      Variables_wrapped = factor(Variables_wrapped,
                                levels = unique(Variables_wrapped[order(-n_significant)]))
    )

  ggplot(heatmap_data_smd, aes(x = Variables_wrapped, y = outcome_labeled)) +
    geom_tile(aes(fill = fill_value, 
                  color = ifelse(variable %in% c("Emotional problems", "Prosocial behavior"), "azure2", "black")), 
              size = 0.5) +
    scale_color_identity() +
    geom_text(
      aes(label = ifelse(pval_adj < 0.05,
                         gsub("^(-?)0\\.", "\\1.", sprintf("%.3f", y)), ""),
          size = ifelse(outcome_labeled == "Y4", 2, 3.5)
      ),
      color = "black"
    ) +
    scale_size_identity() +
    coord_polar(theta = "x", start = 0, direction = 1, clip = "off") +
    scale_fill_gradient2(
      low = "#2166ac", 
      mid = "white", 
      high = "#d73027",
      midpoint = 0,
      # limits = c(-.1, 
      #            max(heatmap_data_smd$fill_value, na.rm = TRUE)),
      na.value = "white",
      guide = "none"
    ) +
    labs(
      title = "Standardised Mean Difference",
      subtitle = expression(frac(bar(X)[attritioned] - bar(X)[original], SD[original])),
      tag = "A"
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 0, size = 11),
      axis.text.y = element_blank(),
      axis.title = element_blank(),
      panel.grid = element_blank(),
      panel.background = element_blank(),
      plot.background = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 16),
      plot.subtitle = element_text(hjust = 0.5, size = 13.5, margin = margin(b = -20)),
      plot.tag = element_text(hjust = 0, vjust = 0, size = 30, face = "bold"),
      plot.tag.position = "topleft",
      plot.margin = margin(2, 10, -33, 10)
    ) +
    {
      y_positions = seq_along(levels(heatmap_data_smd$outcome_labeled))
      labels = levels(heatmap_data_smd$outcome_labeled)

      lapply(seq_along(labels), function(i) {
        annotate("text", x = 0.5, y = y_positions[i], 
                 label = paste0(labels[i], " "), 
                 size = 3.7, 
                 hjust = 1, angle = 7)
      })
    }

  save_plot("2_rq2_circular_heatmap_smd", width = 8, height = 8)





```

### Variance Differences

```{r}
  # Create circular heatmap for variance differences
   heatmap_data_var = variable_comparisons_df %>%
    filter(stat == "var") %>%
    mutate(
      outcome_labeled = rq1y_twin_labels_clean_extrashort[match(dataset, rq1y_twin_labels_clean)],
      outcome_labeled = factor(outcome_labeled, levels = rq1y_twin_labels_clean_extrashort),
      Variables_wrapped = str_wrap(variable, width = 8),
      # Set fill value to NA if not significant, otherwise keep original sign
      fill_value = case_when(
        pval_adj < 0.05 ~ y,
        TRUE ~ NA
      )
    ) %>%
    # Order variables by number of significant effects
    group_by(variable) %>%
    mutate(n_significant = sum(pval_adj < 0.05)) %>%
    ungroup() %>%
    mutate(
      Variables_wrapped = factor(Variables_wrapped,
                                levels = unique(Variables_wrapped[order(-n_significant)]))
    )

  ggplot(heatmap_data_var, aes(x = Variables_wrapped, y = outcome_labeled)) +
    geom_tile(aes(fill = fill_value, 
                  color = ifelse(variable %in% c("Emotional problems", "Prosocial behavior", "Hyperactivity", "Grammar"), "azure2", "black")), 
              size = 0.5) +
    scale_color_identity() +
    geom_text(
      aes(label = ifelse(pval_adj < 0.05,
                         paste0(sprintf("%.1f", y * 100), "%"), ""),
          size = ifelse(outcome_labeled == "Y4", 2, 3.5)
      ),
      color = "black"
    ) +
    scale_size_identity() +
    coord_polar(theta = "x", start = 0, direction = 1, clip = "off") +
    scale_fill_gradient2(
      low = "#2166ac", 
      mid = "white", 
      high = "#d73027",
      midpoint = 0,
      limits = c(-max(abs(heatmap_data_var$fill_value), na.rm = TRUE), 
                 max(abs(heatmap_data_var$fill_value), na.rm = TRUE)),
      na.value = "white",
      guide = "none"
    ) +
    labs(
      title = "Variance Percentage Change",
      subtitle = expression(frac(Var[attritioned] - Var[original], Var[original]) %*% 100),
      tag = "B"
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 0, size = 11),
      axis.text.y = element_blank(),
      axis.title = element_blank(),
      panel.grid = element_blank(),
      panel.background = element_blank(),
      plot.background = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 16),
      plot.subtitle = element_text(hjust = 0.5, size = 13.5, margin = margin(b = -20)),
      plot.tag = element_text(hjust = 0, vjust = 0, size = 30, face = "bold"),
      plot.tag.position = "topleft",
      plot.margin = margin(2, 10, -33, 10)
    ) +
    {
      y_positions = seq_along(levels(heatmap_data_var$outcome_labeled))
      labels = levels(heatmap_data_var$outcome_labeled)

      lapply(seq_along(labels), function(i) {
        annotate("text", x = 0.5, y = y_positions[i],
                 label = paste0(labels[i], " "), size = 3.7, hjust = 1, angle = 7)
      })
    }

  save_plot("2_rq2_circular_heatmap_var", width = 8, height = 8)

```



## Plot Hellingers and SMD

```{r}

variable_comparisons_df %>%
  mutate(sig = pval_adj < .05) %>%
  filter(stat == "smd") %>%
  mutate(dataset = factor(dataset, levels = unique(variable_comparisons_df$dataset))) %>%
  ggplot(aes(x = variable, y = y, ymin = ymin, ymax = ymax, fill = sig)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_col() +
  geom_errorbar() +
  facet_wrap(~dataset, scales = "fixed") +
  coord_flip() +
  theme_bw() +
  labs(
    title = "Attritioned - Original Variable Means (standardised mean differences)"
  )

save_plot("2_difference_means", width = 8, height = 6)

```


Plot data distributions

```{r}

attritioned_datasets_long = attritioned_datasets

for (i in seq_along(attritioned_datasets_long)){
  attritioned_datasets_long[[i]] = gather(as.data.frame(as.matrix(attritioned_datasets[[i]])))
  attritioned_datasets_long[[i]]$dataset = rq1y_twin1[i]
}

x = original_dataset %>%
    as.matrix() %>% as.data.frame() %>%
    gather() %>%
    mutate(dataset = "original")

attritioned_datasets_long = c(attritioned_datasets_long, list(x))

attritioned_datasets_long = do.call(rbind.data.frame,attritioned_datasets_long)

attritioned_datasets_long = attritioned_datasets_long %>%
  filter(!is.na(value))

attritioned_datasets_long %>%
  mutate(dataset = factor(dataset)) %>%
  ggplot(aes(x = value, group = dataset, col = dataset)) + 
  geom_density() + 
  facet_wrap(~key, scales = "free")

```

# Compare Correlation Structure between original and attrittioned data sets

First, some code to establish how to convert variable labels from matrix to dataframe formats.

```{r}
test_correlation_matrix = matrix(
  nrow = length(rq2y),
  ncol = length(rq2y)
  )

for(i in seq_along(rq2y)){
  for(j in seq_along(rq2y)){
    test_correlation_matrix[i,j] = paste(rq2y[i], rq2y[j], collapse = " ")
  }
}

x = test_correlation_matrix[lower.tri(test_correlation_matrix)]

x_var = str_extract(x, "^\\S+")
y_var = str_extract(x, "\\S+$")

rm(test_correlation_matrix,x)
```

## Plot changes in correlations

```{r}

correlation_comparisons = lapply(variable_comparisons, function(x) x$bootstrap_summary$cor_resid)

correlation_comparisons = lapply(correlation_comparisons, function(x) do.call(rbind.data.frame, x))

correlation_comparisons = lapply(correlation_comparisons, function(x) {
  x %>% 
    mutate(pval_adj = stats::p.adjust(pval, method = "holm"))
})

library(patchwork)

plots = lapply(1:length(correlation_comparisons), function(i) {
  correlation_comparisons[[i]] %>%
    plot_lower_triangular_matrix(
      title = var_to_label(rq1y_twin1)[i] %>% 
        str_remove(", 1Y 0N") %>%
        stringr::str_wrap(., width = 35),
      
     caption = paste0("Variable name: ", rq1y_twin1[i])
    )
})

patchwork::wrap_plots(
  plots,
  ncol = 3) 
  # Adjust ncol as needed

save_plot(
  "2_rq2_2_correlations", width = 18, height = 18)
  
  

```

[ðŸ“Š View Full Resolution Correlation Plots (PDF)](plots/pdfs/2_rq2_2_correlations.pdf)

## Plot Original Correlations between variables

```{r}

df %>%
  select(rq2y) %>%
  data.frame() %>%
  `colnames<-`(rq2y_labels_short) %>%
   gbtoolbox::plot_correlations()

save_plot(
  "2_rq2_2_correlations_orignal", width = 8, height = 8)

```


# Compare ACE estimates between original and attritioned datasets

```{r}

ace_comparisons = readRDS(file = file.path("results", "2_ace_comparisons.Rds"))

# Extract ACE estimates from original (non-attrittioned) dataset

boot_results_original_df = lapply(ace_comparisons, function(x) x$boot_results_original_df)

boot_results_original_df = map_dfr(boot_results_original_df, ~ .x, .id = "variable")

boot_results_original_df_summary = boot_results_original_df %>%
  pivot_longer(cols = c(a,c,e)) %>%
  group_by(variable, name) %>%
  summarise(
    results = .mean_qi_pd(value),
    .groups = "drop"
  ) %>%
  unnest(cols = results)

# Extract changes in ACE parameters across bootstrap resamples

ace_comparisons_df = lapply(ace_comparisons, function(x) x$boot_results_differences_summary)

ace_comparisons_df = map_dfr(ace_comparisons_df, ~ map_dfr(.x, ~ map_dfr(.x, ~ .x, .id = "component"), .id = "dataset"), .id = "variable")

# Attritioned datasets: Extract mean estimates of ACE parameters across bootstrap resamples

ace_boot_results_attritioned_df = lapply(ace_comparisons, function(x) x$boot_results_attritioned_df)

ace_boot_results_attritioned_df = map_dfr(ace_boot_results_attritioned_df, ~ map_dfr(.x, ~ map_dfr(.x, ~ .x, .id = "component"), .id = "dataset"), .id = "variable")

ace_boot_results_attritioned_df %>% 
  pivot_longer(cols = c(a,c,e), names_to = "parameter") %>%
  group_by(variable, dataset, parameter) %>% 
  summarise(
    results = .mean_qi_pd(value),
    .groups = "drop"
  ) %>%
  unnest(results) 
  
```

Test for significant changes

```{r}

ace_comparisons_df

ace_comparisons_df %>% 
  ggplot(aes(x = pval)) + 
  geom_histogram(bins = 10) + 
  labs(
    title = "Histogram of p-values testing for changes in ACE parameters\nfrom original to attritioned groups"
  )

```

Ternery Plot

```{r}

rm(points_data, estimate_data, coordinates, var_colors)

pdf(file.path("plots","pdfs","2_2_ace_ternary_plot.pdf"), width = 7, height = 7)

# Non-attritioned ACE estimates
original_ace_estimates = boot_results_original_df_summary %>%
  pivot_wider(values_from = y, names_from = name, id_cols = variable)

original_ace_estimates$variable_shortlabel = rq2y_labels_short[match(original_ace_estimates$variable, rq2y_prefix)]

attritioned_ace_estimates = ace_boot_results_attritioned_df %>%
  pivot_longer(cols = c(a,c,e), names_to = "parameter") %>%
  group_by(variable, dataset, parameter) %>%
  summarise(
    estimate = mean(value),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = parameter, values_from = estimate)

library(Ternary)

TernaryPlot(
  alab = "Additive Genetic (A)", 
  blab = "Common Environment (C)", 
  clab = "Unique Environment (E)",
  # main = title,
  grid.lines = 5,
  grid.col = "lightgray",
  axis.col = c("#D81B60", "#1E88E5", "#111111"),
  lab.col = c("#D81B60", "#1E88E5", "#111111")
)


var_colors = RColorBrewer::brewer.pal(length(rq2y), "Paired")

TernaryPoints(
  original_ace_estimates[c("a","c","e")], 
  pch = 16,  # filled circles
  cex = 1,
  col = var_colors[match(original_ace_estimates$variable, rq2y_prefix)]
)

TernaryPoints(
  attritioned_ace_estimates[,c("a","c","e")], 
  pch = 4,  
  cex = .9,
  col = var_colors[match(attritioned_ace_estimates$variable, rq2y_prefix)]
)

TernaryText(
  coordinates = original_ace_estimates[c("a","c","e")], #%>% mutate(c = c+.1,a=a+.1),
  labels = original_ace_estimates$variable_shortlabel,
  # col = var_colors[match(original_ace_estimates$variable, rq2y_prefix)],
  col = "black",
  cex = 0.5,           # Text size
  pos = 3,             # Position: 1=below, 2=left, 3=above, 4=right
  offset = 0.5         # Distance from point
)

dev.off()


```

[View ACE Ternary Plot](plots/pdfs/2_2_ace_ternary_plot.pdf)


Why are the ACE estimates weird? 

```{r}

df %>%
  filter(random == 1) %>% 
  filter(x3zygos == "DZ same sex") %>%
  select(bsdqchypt1, bsdqchypt2) %>%
  {cor.test(.$bsdqchypt1, .$bsdqchypt2)}

df %>%
  filter(random == 1) %>% 
  filter(x3zygos == "MZ") %>%
  select(bsdqchypt1, bsdqchypt2) %>%
  {cor.test(.$bsdqchypt1, .$bsdqchypt2)}

df %>%
  filter(random == 1) %>% 
  filter(sexzyg == "DZ female") %>%
  select(bsdqchypt1, bsdqchypt2) %>%
  {cor.test(.$bsdqchypt1, .$bsdqchypt2)}

df %>%
  filter(random == 1) %>% 
  filter(sexzyg == "MZ female") %>%
  select(bsdqchypt1, bsdqchypt2) %>%
  {cor.test(.$bsdqchypt1, .$bsdqchypt2)}

df %>%
  filter(random == 1) %>% 
  filter(sexzyg == "DZ male") %>%
  select(bsdqchypt1, bsdqchypt2) %>%
  {cor.test(.$bsdqchypt1, .$bsdqchypt2)}

df %>%
  filter(random == 1) %>% 
  filter(sexzyg == "MZ male") %>%
  select(bsdqchypt1, bsdqchypt2) %>%
  {cor.test(.$bsdqchypt1, .$bsdqchypt2)}



```

# How predictive are our variables of later attrittion?

## Correlations

```{r}

sapply(rq2y, function(x)
  sapply(rq1y_twin1, function(y)
         cor(df[[x]],df[[y]], use = "pairwise.complete.obs")
  )) %>%
  `colnames<-`(rq2y_labels_short) %>%
  `rownames<-`(rq1y_twin_labels_clean_extrashort) %>%
  knitr::kable(digits = 3)

```


## Regression Modelling 

```{r}



models = list()

for (i in seq_along(rq1y_twin1)){
  cat(i, "/", length(rq1y_twin1),"\n")
  formula <- as.formula(paste(rq1y_twin1[i], "~", paste(rq2y, collapse = "+")))
  models[[i]] = glm(formula, data = df, family = binomial, na.action = "na.omit")
}


# glm_model_comparison(models[[1]])
# 
# lapply(models, function(x) performance::r2(x))
# lapply(models, function(x) calc_auc(x))
# lapply(models, function(x) summary(x))



# calc_auc(models[[1]])

```


### Plot of AUC and R2 for each timepoint 

```{r}

# Extract AUC and pseudo R2 for each model
model_metrics = data.frame(
  outcome = sapply(models, function(x) as.character(x$formula)[2]),
  AUC = sapply(models, calc_auc),
  R2 = sapply(models, function(x) performance::r2(x)$R2)
) %>%
  mutate(outcome = rq1y_twin_labels_clean[match(.$outcome, rq1y_twin1)])

# First, order the outcomes chronologically by extracting year numbers
model_metrics_ordered = model_metrics %>%
  mutate(
    year_num = as.numeric(str_extract(outcome, "\\d+")),
    outcome = fct_reorder(outcome, year_num)
  )

plot_data = model_metrics_ordered %>%
  pivot_longer(cols = c(AUC, R2)) %>%
  mutate(
    # Format labels
    label_text = ifelse(name == "R2", 
                       paste0(sprintf("%.1f", value * 100), "%"),
                       sprintf("%.3f", value)),
    label_text = ifelse(name == "AUC", 
                       gbtoolbox::apa_num(value, n_decimal_places = 3),
                       label_text),
    # Adjust bar start position for AUC (start from 0.5 instead of 0)
    value_start = ifelse(name == "AUC", 0.5, 0),
    value_width = value - value_start
  )

plot_data %>%
  ggplot(aes(y = outcome)) +
  geom_rect(aes(xmin = value_start, xmax = value, ymin = as.numeric(outcome) - 0.4, ymax = as.numeric(outcome) + 0.4), 
            fill = "steelblue", alpha = 0.7) + 
  geom_text(aes(x = value, label = label_text), hjust = -0.1, size = 3) +
  facet_wrap(~name, scales = "free", 
             labeller = labeller(name = c("AUC" = "AUC", "R2" = "Tjur's RÂ²"))) +
  scale_x_continuous(
    labels = function(x) {
      # Check if we're in the R2 facet by looking at the range
      if (max(x, na.rm = TRUE) < 0.2) {  # R2 values are typically small
        paste0(round(x * 100, 1), "%")
      } else {
        sprintf("%.2f", x)
      }
    },
    expand = expansion(mult = c(0, 0.15)),
    limits = function(x) {
      # Set minimum limit to 0.5 for AUC facet (values > 0.2)
      if (max(x, na.rm = TRUE) > 0.2) {
        c(0.5, max(x, na.rm = TRUE) * 1.05)
      } else {
        c(0, max(x, na.rm = TRUE) * 1.05)
      }
    }
  ) +
  labs(
    title = "Prediction Accuracy Across Study Timepoints",
    x = "Value",
    y = "Study Timepoint"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5)
  )

save_plot("2_prediction_accuracy", width = 9, height = 6)

```

### Full model results 

```{r}

# Extract all coefficients and combine
models_results = do.call(rbind, lapply(1:length(models), function(i) {
  coefs = tidy(models[[i]])
  coefs$outcome = as.character(models[[i]]$formula)[2]
  return(coefs)
}))

models_results %>% 
  select(outcome, everything()) %>%
  mutate(
    outcome = var_to_label(outcome) %>% str_remove("data.*"),
    term = df_labels[match(.$term,df_colnames)],
    term   = ifelse(is.na(term), "Intercept", term),
    p_star = as.character(symnum(p.value, cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1), symbols = c("***", "**", "*", ".", " ")))
  ) %>% 
  knitr::kable(., digits = 3)


```


### Variable Importance Calculations

This code should be checked again before use! 

```{r}
glm_model_comparison_results = lapply(models, glm_model_comparison)

glm_model_comparison_results_df = do.call("rbind.data.frame", glm_model_comparison_results)

# glm_model_comparison_results_df$LRT_p_star = glm_model_comparison_results_df$LRT_p %>%
#   symnum(., cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1), symbols = c("***", "**", "*", ".", " "))

# Adjust p-values and add star

glm_model_comparison_results_df = glm_model_comparison_results_df %>% 
  filter(Variables_Dropped!="None") %>%
  group_by(outcome) %>%
  mutate(LRT_p = stats::p.adjust(LRT_p, method = "holm")) %>% 
  ungroup() %>%
  mutate(
    LRT_p_star = as.character(symnum(LRT_p, cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1), symbols = c("***", "**", "*", ".", " ")))
  )

variable_importance_order = glm_model_comparison_results_df %>%
  group_by(Variables_full) %>%
  summarise(mean_score = mean(LRT_p)) %>%
  arrange(mean_score) %>%
  pull(Variables_full)
glm_model_comparison_results_df = glm_model_comparison_results_df %>%
  mutate(
    Variables_full = factor(Variables_full, levels = variable_importance_order)
  )

# Plotting code
glm_model_comparison_results_df %>%
  mutate(
    Variables_full = rq2y_labels_short[match(.$Variables_full, rq2y_labels)],
    outcome_labeled = rq1y_twin_labels_clean_extrashort[match(.$outcome, rq1y_twin1)],
    criterion       = Delta_AUC,
    sig_level = case_when(
      LRT_p < 0.001 ~ "p < 0.001",
      LRT_p < 0.01 ~ "p < 0.01", 
      LRT_p < 0.05 ~ "p < 0.05",
      LRT_p < 0.1 ~ "p < 0.1",
      TRUE ~ "Not significant"
    ),
    sig_level = factor(sig_level, levels = c("p < 0.001", "p < 0.01", "p < 0.05", "p < 0.1", "Not significant"))
  ) %>%
  ggplot(aes(y = Variables_full, x = criterion)) + 
  geom_col(aes(fill = sig_level), alpha = 0.8) + 
  geom_text(aes(label = gsub("0\\.", ".", sprintf("%.3f", criterion))),  # Remove ALL 0. patterns
            size = 2.5, fontface = "bold", color = "black") +
  facet_wrap(~outcome_labeled, scales = "fixed", ncol = 6) +
  scale_x_continuous(labels = function(x) gsub("0\\.", ".", sprintf("%.3f", x))) +  # Remove ALL 0. patterns
  scale_fill_manual(
    values = c("p < 0.001" = "#d73027", "p < 0.01" = "#fc8d59", 
               "p < 0.05" = "#fee08b", "p < 0.1" = "#e0f3f8", 
               "Not significant" = "#d9d9d9"),
    name = "Significance\n(Holm-adjusted)"
  ) +
  labs(
    x = "Change in AUC (when variable removed)",
    y = NULL,
    title = "Variable Importance by AUC Change",
    subtitle = "Colors show Holm-adjusted significance levels"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 7),
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    strip.text = element_text(size = 9, face = "bold"),
    legend.position = "bottom"
  )


save_plot("2_rq2_variable_importance", width = 14, height = 7)
```


# Comparison of maternal education scores

```{r}

df %>% 
  # group_by(zcdata1) %>%
  summarise(
    mean = mean(amohqualn, na.rm = TRUE),
    var  = stats::var(amohqualn1, na.rm = TRUE),
    sd  = stats::sd(amohqualn1, na.rm = TRUE)
    )


df %>% 
  group_by(zcdata1) %>%
  summarise(
    mean = mean(amohqualn, na.rm = TRUE),
    var  = stats::var(amohqualn1, na.rm = TRUE),
    sd   = stats::sd(amohqualn1, na.rm = TRUE)
    
    )

```


# Random / Code Checks

```{r}
#| eval: false 

# Hellingers distances

# Small

statip::hellinger(rnorm(100000,1,1),rnorm(100000,1.2,1))*sqrt(2)

# Medium

statip::hellinger(rnorm(100000,1,1),rnorm(100000,1.5,1))*sqrt(2)

# Large

statip::hellinger(rnorm(100000,1,1),rnorm(100000,2,1))*sqrt(2)

# Huge

statip::hellinger(rnorm(100000,1,1),rnorm(100000,1,10))*sqrt(2)

# More tests

distrEx::HellingerDist(rnorm(1000,1,1),rnorm(1000,3,1), asis.smooth.discretize = "smooth")


HellingerDist(c(.3,.5,.2),c(.3,.6,.3))

statip::hellinger(rnorm(100000,1,1),rnorm(100000,3,1))*sqrt(2)

HellingerDist(rbinom(50, size = 20, prob = 0.5), Binom(size = 20, prob = 0.5))

apply(attritioned_datasets[[1]],2, function(x) length(which(!is.na(x))))


df %>%
  select(bcontact)


# rq2y
# rq1y[10]
# 
# calc_smd(
# cleanvar(original_dataset$bvocab1),
# cleanvar(attritioned_datasets[[9]]$bvocab1)
# )
# 
# calc_md(
# cleanvar(original_dataset$bvocab1),
# cleanvar(attritioned_datasets[[9]]$bvocab1)
# )
# 
# calc_smd(
# cleanvar(original_dataset$bvocab1),
# cleanvar(attritioned_datasets[[9]]$bvocab1)
# )
# 
# calc_smd(
# cleanvar(original_dataset$bvocab1),
# cleanvar(attritioned_datasets[[4]]$bvocab1)
# )
# 
# x=compare_df(
#   attritioned_datasets[[9]],
#   original_dataset
# )
# 
# x=compare_smd(
#   attritioned_datasets[[9]],
#   original_dataset
# )

# compare_smd(
#   attritioned_datasets[[9]],
#   original_dataset
# )

calc_smd(
   cleanvar(attritioned_datasets[[9]]$brawg1),
   cleanvar(original_dataset$brawg1)
)

statip::hellinger(
   cleanvar(attritioned_datasets[[9]]$brawg1),
   cleanvar(original_dataset$brawg1)
)



variable_comparisons_df %>%
  filter(dataset == "rcqdata") %>%
  filter(stat != "md") 

rq1y[9]
```

---
title: "Descriptive Information"
format: 
  html:
    fig-width: 8
    fig-height: 8
    code-link: true
    code-fold: true
    code-tools: true
    df-print: paged
    toc: true
    grid:
      body-width: 900px
editor: source
---

# Load initial script

```{r}
source("0_load_data.R")
```


# Participation-Related plots

## Missing Data at each timepoint 


```{r}

df %>%
  select(c(acontact,rq1y)) %>%
  sapply(., function(x) length(which(x==1))/length(which(x>=0))) %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  `colnames<-`(c("Time Point","Participation Rate")) %>%
  mutate(`Time Point` = factor(`Time Point`, levels = `Time Point`, labels = var_to_label(`Time Point`))) %>%
  ggplot(aes(x = `Participation Rate`, y = `Time Point`)) + 
  geom_col() +
    geom_text(
    aes(label = paste0(round(`Participation Rate` * 100, 1), "%")),
    hjust = 1.1,  # Right align inside the bar (>1 moves it inside)
    color = "white",
    size = 3.5,
    fontface = "bold"
  ) +
  # geom_vline(aes(xintercept=.2)) +
  theme_bw()

ggsave(file.path("plots","11_participation_rate.pdf"), width = 9, height = 5)

```


## How many different time points do we have for each participant (excluding first contact)

```{r}

df %>% 
  select(c(rq1y)) %>% 
  apply(., 1, function(x) sum(x)) %>% 
  tibble(`Number Time Points Participated` = .) %>% 
  count(`Number Time Points Participated`) %>% 
  ggplot(aes(x = `Number Time Points Participated`, y = n)) + 
  geom_col() + 
  geom_text(aes(label = n), vjust = 1.2, color = "white", size = 3.5) +
  theme_bw() + 
  labs(
    title = "How many times has each pps been tested (exl. first contact)?",
    subtitle = "Twin-level participation numbers (N = 27890)"
    )

ggsave(file.path("plots","11_number_of_times_each_twin_participated.pdf"), width = 9, height = 5)

```
## How predictive is cohort and year of birth in participation at each timepoint? 

I've checked there are no missing values for cohort or year of birth (aonsby)

[View full-sizeplot](plots/11_r2_participation_cohort_birthyear.pdf){target="_blank"}

```{r}
models = list()

for (i in seq_along(rq1y)){
  # cat(i, "/", length(rq1y),"\n")
  formula <- as.formula(paste(rq1y[i], "~ cohort + aonsby"))
  models[[i]] = glm(formula, data = df, family = binomial)
}

var_explained = sapply(models, function(x) as.numeric(performance::r2(x)))

cbind.data.frame(rq1y, rq1y_labels, var_explained) %>%
  `colnames<-`(c("Var","Label","R2 by Cohort and Birth Year")) %>%
  knitr::kable(digits = 2)


cbind.data.frame(rq1y, rq1y_labels, var_explained) %>%
  `colnames<-`(c("Var","Label","Variance Explained")) %>%
  mutate(
    Label = factor(Label, levels = rq1y_labels)
  ) %>%
  ggplot(aes(x=Label,y=`Variance Explained`)) + 
  geom_col() + 
  geom_text(aes(label = gbtoolbox::apa_num(`Variance Explained`)),
            vjust = 1.1, color = "white", size = 3) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, vjust=1)) +
  scale_x_discrete(expand = expansion(mult = c(0.1, 0)))

ggsave(file.path("plots","11_r2_participation_cohort_birthyear.pdf"), width = 9, height = 5)


```

At the Y18 time point, we see that those in cohort 1 and those born in 1994 are less likely to participate. 

```{r}

rq1y[10]

var_to_label(rq1y[10])

summary(models[[10]])

```



### Cohort alone is not helpful for determining who was eligible at t2 and t3

As we can see below, nobody in cohort 4 took part in Y2, Y3, Y10 data collection. However, a minority of participants took part in Y2-Y3 from cohort 3, but participation rates are quite low suggesting that some participants were elibile and some not. 

```{r}

 table(df0$cohort, df0$btwoyear)
 table(df0$cohort, df0$cthreeyr)
 table(df0$cohort, df0$jtenyear)

```

```{r}

 table(df0$aonsby, df0$btwoyear)
 table(df0$aonsby, df0$cthreeyr)
 table(df0$aonsby, df0$jtenyear)

```




## Participation Patterns

```{r}

df %>%
  select(c(rq1y)) %>% 
  rename_with(~var_to_label(., df)) %>%
  mutate_all(~na_if(., 0)) %>%
  ggmice::plot_pattern(npat = 70, rotate = TRUE) + 
  scale_x_discrete(limits = (var_to_label(rq1y))) + 
  coord_flip()

ggsave(file.path("plots","11_participation_pattern.pdf"), width = 19, height = 6)


df %>%
  select(c(rq1y)) %>%
  mutate_all(~ .==1) %>%
  rowwise() %>%
  mutate(
    `Year 2 - 4 present`   = any(btwoyear, cthreeyr, dfouryr),
    `Year 7 - 12 present`  = any(gsevenyr, heightyr, jtenyear),
    `Year 14 - 16 present` = any(n14year, p16year),
    `Year 18 - 26 present` = any(rcqdata, uteds21data, zmhdata)
  ) %>%
  select(ends_with("present")) %>%
  mutate_all(~ na_if(., FALSE)) %>%
  ggmice::plot_pattern(rotate = TRUE) + 
  scale_x_discrete(limits = c("Year 2 - 4 present", "Year 7 - 12 present", "Year 14 - 16 present", "Year 18 - 26 present")) + 
  coord_flip()

ggsave(file.path("plots","11_participation_pattern_grouped.pdf"), width = 19, height = 6)

df %>%
  select(c(rq1y)) %>%
  rename_with(~var_to_label(., df)) %>%
  rename_with(~clean_rq1y_label(.)) %>%
  mutate_all(~ na_if(., 0)) %>%
  gbtoolbox::plot_pairwise_missing(textadjust = 2.5) +
  labs(subtitle = "Number of twins tested at each time point (diagonal) and \npair of time points (below diagonal)")

ggsave(file.path("plots","11_pairwise_missingness_plot.pdf"), width = 6, height = 6)

```


# Age of twins at each time point

[View full-size plot](plots/11_participant_ages_each_timepoint.pdf){target="_blank"}


```{r}

df_age = df %>%
  select(contains("age")) %>%
  select(-contains("genpro"), -contains("mumage"), - contains("dadage"), -ends_with("2")) 

df_age_long = df_age %>%
  `colnames<-`(var_to_label(colnames(df_age))) %>%
  pivot_longer(cols = everything())

df_age_long %>% 
  mutate(name = factor(name, levels = var_to_label(colnames(df_age)))) %>%
  ggplot(aes(x=value)) + 
  geom_histogram(bins = 100) +
  facet_wrap(~name, ncol =3) + 
  scale_x_continuous(breaks = seq(0,30,by=2)) +
  theme_bw() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank()
    )

ggsave(file.path("plots","11_participant_ages_each_timepoint.pdf"), width = 12, height = 12)


```


# Classify participation patterns


[ðŸ“Š Class Analysis Plot (needs work)](plots/99_class_analysis.pdf)
 

# Research Question 5




